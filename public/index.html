<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Suno –ö–ª–∏–µ–Ω—Ç (Personal)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505; --sidebar-bg: #0c0c0c; --panel-bg: #141414;
            --input-bg: #1f1f1f; --text-main: #ededed; --text-muted: #888888;
            --accent: #fff; --border: #2a2a2a; --button-primary: #ffffff; --button-text: #000000;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* LAYOUT */
        .sidebar { width: 400px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; z-index: 20; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-weight: 800; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .logo span { background: var(--text-main); color: black; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; }
        .icon-btn { background: transparent; border: 1px solid #333; color: #888; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:hover { color: white; border-color: #666; background: #222; }

        .form-container { padding: 24px; flex: 1; display: flex; flex-direction: column; gap: 24px; }
        .mode-toggle { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--text-main); }
        input:checked + .slider:before { transform: translateX(18px); background-color: black; }

        /* INPUTS */
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 0.05em; }
        input[type="text"], textarea, select, input[type="number"] { background: var(--input-bg); border: 1px solid #333; color: var(--text-main); padding: 14px; border-radius: 10px; font-family: inherit; font-size: 0.95rem; resize: vertical; transition: 0.2s; }
        input[type="text"]:focus, textarea:focus, select:focus { border-color: #666; background: #222; }
        textarea { min-height: 110px; line-height: 1.5; }
        .upload-area { border: 1px dashed #444; padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; font-size: 0.85rem; color: #888; }
        .upload-area:hover { border-color: #777; background: #222; color: #fff; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* OPTIONS */
        .model-select { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 5px; }
        .model-opt { background: var(--input-bg); padding: 10px; text-align: center; border-radius: 8px; font-size: 0.85rem; cursor: pointer; border: 1px solid #333; color: var(--text-muted); transition: 0.2s; font-weight: 500; }
        .model-opt:hover { background: #2a2a2a; border-color: #555; }
        .model-opt.active { background: var(--text-main); color: black; font-weight: 700; border-color: white; }

        .advanced-toggle { font-size: 0.8rem; color: #888; cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-top: 1px solid #222; margin-top: 10px; }
        .advanced-content { display: none; flex-direction: column; gap: 20px; padding-top: 10px; }
        .advanced-content.show { display: flex; }

        .create-btn { background: var(--button-primary); color: var(--button-text); padding: 16px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
        .create-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 15px rgba(255,255,255,0.1); }
        .create-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* FEED */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-color); position: relative; overflow: hidden; }
        .feed-header { padding: 24px 40px; display: flex; justify-content: space-between; align-items: center; background: rgba(5,5,5,0.9); border-bottom: 1px solid var(--border); z-index: 10; backdrop-filter: blur(10px); }
        .feed-title { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.02em; }
        .feed-list { padding: 40px; overflow-y: auto; flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; align-content: start; }

        /* CARDS */
        .card { background: #111; border-radius: 16px; overflow: hidden; position: relative; width: 100%; padding-top: 100%; height: 0; border: 1px solid #333; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-6px); box-shadow: 0 15px 40px rgba(0,0,0,0.6); border-color: #555; z-index: 5; }
        .card-img { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .card:hover .card-img img { transform: scale(1.08); }
        .card-body { position: absolute; bottom: 0; left: 0; right: 0; z-index: 2; padding: 16px; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 60%, transparent 100%); display: flex; flex-direction: column; gap: 6px; justify-content: flex-end; height: 50%; }
        .card-title { font-weight: 800; font-size: 1.1rem; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.8); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-tags { display: flex; gap: 5px; overflow: hidden; height: 22px; opacity: 0.9; }
        .tag-pill { background: rgba(255,255,255,0.15); backdrop-filter: blur(4px); color: #ddd; font-size: 0.65rem; padding: 3px 8px; border-radius: 4px; }
        .card-meta-row { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; font-size: 0.75rem; color: #ccc; }
        .status-badge { position: absolute; top: 12px; left: 12px; z-index: 5; padding: 5px 10px; border-radius: 20px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .status-badge.submitted { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .status-badge.succeeded { background: rgba(30, 215, 96, 0.8); color: black; border: none; }
        .status-badge.failed { background: rgba(255, 68, 68, 0.8); color: white; border: none; }
        .ref-badge { position: absolute; top: 12px; right: 12px; z-index: 5; background: rgba(255, 165, 0, 0.8); color: black; padding: 4px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: 700; }
        .delete-btn { background: rgba(0,0,0,0.4); color: #fff; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: 0.2s; backdrop-filter: blur(4px); }
        .delete-btn:hover { background: #fff; color: #000; }

        /* CONSOLE */
        .console-panel { height: 120px; background: #0a0a0a; border-top: 1px solid var(--border); padding: 15px 20px; font-family: 'Consolas', monospace; font-size: 0.8rem; color: #ccc; overflow-y: auto; display: flex; flex-direction: column-reverse; transition: margin-bottom 0.4s ease; }
        .console-panel.with-player { margin-bottom: 90px; }
        .log-entry { margin-bottom: 4px; padding-bottom: 2px; border-bottom: 1px solid #161616; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal { background: #111; width: 90%; max-width: 900px; max-height: 85vh; border-radius: 16px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 40px 80px rgba(0,0,0,0.8); }
        .modal-header { padding: 20px 30px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; background: #161616; }
        .modal-title { font-size: 1.2rem; font-weight: 700; color: white; }
        .close-btn { background: none; border: none; color: #666; font-size: 1.8rem; cursor: pointer; line-height: 1; }
        .close-btn:hover { color: white; }
        .modal-body { padding: 0; display: flex; overflow: hidden; height: 100%; }
        .modal-sidebar { width: 320px; background: #0c0c0c; border-right: 1px solid #222; padding: 25px; overflow-y: auto; flex-shrink: 0; }
        .modal-main { flex: 1; padding: 30px; overflow-y: auto; background: #111; }
        .info-row { margin-bottom: 18px; }
        .info-label { font-size: 0.7rem; color: #555; text-transform: uppercase; font-weight: 800; margin-bottom: 6px; display: block; letter-spacing: 0.05em; }
        .info-val { font-size: 0.9rem; color: #ddd; font-weight: 500; }

        /* PLAYER */
        .global-player { position: fixed; bottom: 0; left: 0; right: 0; height: 90px; background: rgba(10, 10, 10, 0.95); border-top: 1px solid #333; backdrop-filter: blur(15px); z-index: 200; display: flex; align-items: center; padding: 0 30px; gap: 20px; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .global-player.active { transform: translateY(0); }
        .gp-close-btn { position: absolute; top: -12px; right: -12px; width: 24px; height: 24px; background: #ff4444; color: white; border: 2px solid #111; border-radius: 50%; font-size: 14px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 210; }
        .gp-info { display: flex; align-items: center; gap: 15px; width: 300px; }
        .gp-cover { width: 56px; height: 56px; border-radius: 6px; object-fit: cover; background: #222; }
        .gp-meta { display: flex; flex-direction: column; overflow: hidden; }
        .gp-title { color: #fff; font-weight: 700; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gp-artist { color: #888; font-size: 0.75rem; }
        .gp-controls { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .gp-btns { display: flex; align-items: center; gap: 20px; }
        .gp-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .gp-btn:hover { color: white; transform: scale(1.1); }
        .gp-play { width: 40px; height: 40px; background: white; color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .gp-progress-wrap { width: 100%; max-width: 600px; display: flex; align-items: center; gap: 10px; font-size: 0.75rem; color: #666; font-family: monospace; }
        .gp-range { flex: 1; height: 4px; border-radius: 2px; background: #333; appearance: none; cursor: pointer; }
        .gp-range::-webkit-slider-thumb { appearance: none; width: 10px; height: 10px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .gp-extras { display: flex; align-items: center; gap: 15px; width: 300px; justify-content: flex-end; }
        .fx-btn { font-size: 0.75rem; font-weight: 700; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; color: #888; background: transparent; cursor: pointer; }
        .fx-btn.on { background: #fff; color: #000; border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .fx-popup { position: absolute; bottom: 100px; right: 30px; background: #111; border: 1px solid #333; border-radius: 12px; padding: 20px; width: 280px; display: none; flex-direction: column; gap: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .fx-popup.show { display: flex; }
        .fx-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; font-size: 0.8rem; color: #ccc; }
        .fx-slider { flex: 1; accent-color: #fff; }
        #rmsContainer { display:flex; align-items:center; gap:8px; min-width:140px; }
        #rmsCanvas { width: 120px; height: 14px; background: #111; border-radius: 4px; border: 1px solid #222; }
        #rmsValue { font-family: monospace; font-size: 0.8rem; color:#9f9; min-width:48px; text-align:right; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <div class="logo"><span>SUNO</span> CLIENT <small style="font-size:0.5em; opacity:0.6;">V2.0</small></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="icon-btn" onclick="openKeysModal()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ API">üîë</button>
            <div class="mode-toggle" style="margin:0;">
                <label class="switch">
                    <input type="checkbox" id="customModeToggle" checked onchange="toggleMode()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="form-container">
        <div class="input-group">
            <label>–†–µ—Ñ–µ—Ä–µ–Ω—Å (–ê—É–¥–∏–æ/–ö–∞–≤–µ—Ä)</label>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div id="uploadText">üìÅ –ù–∞–∂–º–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                <div id="fileName" class="file-name"></div>
            </div>
            <input type="file" id="fileInput" hidden accept="audio/*">
        </div>

        <div class="input-group">
            <label>
                <span id="lyricsLabel">–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</span>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:0.7rem; color:#666;">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª</span>
                    <label class="switch" style="width:34px; height:18px;">
                        <input type="checkbox" id="instrumentalToggle" onchange="toggleInstrumental()">
                        <span class="slider"></span>
                    </label>
                </div>
            </label>
            <textarea id="prompt" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
        </div>

        <div class="input-group" id="styleGroup">
            <label>–°—Ç–∏–ª—å –º—É–∑—ã–∫–∏</label>
            <textarea id="style" style="min-height: 60px;" placeholder="–Ω–∞–ø—Ä. Dark Trap, Piano, Male Vocals"></textarea>
        </div>

        <div class="input-group" id="titleGroup">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</label>
            <input type="text" id="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
        </div>

        <div class="input-group">
            <label>–ú–æ–¥–µ–ª—å</label>
            <div class="model-select" id="modelSelect">
                <div class="model-opt active" onclick="setModel('V5', this)">V5</div>
                <div class="model-opt" onclick="setModel('V4', this)">V4</div>
                <div class="model-opt" onclick="setModel('V4_5', this)">V4.5</div>
            </div>
        </div>

        <div class="advanced-toggle" onclick="toggleAdvanced()"><span>‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</span><span id="advArrow">‚ñº</span></div>
        <div class="advanced-content" id="advancedContent">
            <div class="input-group"><label>–ò—Å–∫–ª—é—á–∏—Ç—å —Ç–µ–≥–∏ (Negative)</label><input type="text" id="negativeTags" placeholder="—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å"></div>
            <div class="input-group"><label>Persona ID</label><input type="text" id="personaId" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"></div>
            <div class="input-group">
                <label>–ì–æ–ª–æ—Å (Gender)</label>
                <div class="row">
                    <div class="col"><button class="model-opt" style="width:100%" onclick="setGender('any', this)">–õ—é–±–æ–π</button></div>
                    <div class="col"><button class="model-opt" style="width:100%" onclick="setGender('male', this)">–ú—É–∂</button></div>
                    <div class="col"><button class="model-opt" style="width:100%" onclick="setGender('female', this)">–ñ–µ–Ω</button></div>
                </div>
            </div>
            <div class="input-group"><label>–°—Ç—Ä–∞–Ω–Ω–æ—Å—Ç—å <span id="weirdVal" class="range-val">0.5</span></label><input type="range" id="weirdness" min="0" max="1" step="0.01" value="0.5" oninput="document.getElementById('weirdVal').textContent=this.value"></div>
            <div class="input-group"><label>–í–µ—Å —Å—Ç–∏–ª—è <span id="styleVal" class="range-val">0.5</span></label><input type="range" id="styleWeight" min="0" max="1" step="0.01" value="0.5" oninput="document.getElementById('styleVal').textContent=this.value"></div>
            <div class="input-group"><label>–í–µ—Å –∞—É–¥–∏–æ <span id="audioVal" class="range-val">0.5</span></label><input type="range" id="audioWeight" min="0" max="1" step="0.01" value="0.5" oninput="document.getElementById('audioVal').textContent=this.value"></div>
        </div>

        <button class="create-btn" onclick="generate()" id="genBtn"><span>‚ú® –ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</span></button>
        <div id="statusMsg" style="text-align:center; font-size:0.8rem; color:var(--text-muted); min-height:20px;"></div>
    </div>
</div>

<div class="main-content">
    <div class="feed-header">
        <div class="feed-title">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
        <div style="display:flex; gap:12px;">
            <button onclick="importTask()" style="background:#222; border:1px solid #333; color:white; padding:8px 16px; border-radius:8px; cursor:pointer; font-size: 0.85rem; font-weight:600;">–ò–º–ø–æ—Ä—Ç ID</button>
            <button onclick="refreshHistory()" style="background:#fff; border:none; color:black; padding:8px 16px; border-radius:8px; cursor:pointer; font-size: 0.85rem; font-weight:700;">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>
    <div class="feed-list" id="feedList"></div>
    <div class="console-panel" id="consolePanel"><div style="color: #444; font-style: italic;">> –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞...</div></div>
</div>

<div class="modal-overlay" id="detailModal" onclick="if(event.target === this) closeModal()">
    <div class="modal">
        <div class="modal-header"><div class="modal-title" id="mTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</div><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <div class="modal-body">
            <div class="modal-sidebar">
                <div class="info-row" id="mCoverContainer" style="display:none;"><img id="mCover" src="" style="width:100%; border-radius:12px; border:1px solid #333; box-shadow:0 10px 30px rgba(0,0,0,0.5);"></div>
                <div class="info-row"><span class="info-label">–°—Ç–∞—Ç—É—Å</span><span class="info-val" id="mStatus" style="font-family:monospace;">COMPLETED</span></div>
                <div class="info-row"><span class="info-label">ID –ó–∞–¥–∞—á–∏</span><span class="info-val" id="mTaskId" style="font-family:monospace; font-size:0.8rem; color:#666;">-</span></div>
                <div style="border-top:1px solid #222; padding-top:20px; margin-top:20px;">
                    <div class="info-row"><span class="info-label">–ú–æ–¥–µ–ª—å</span><span class="info-val" id="mModel">-</span></div>
                    <div class="info-row"><span class="info-label">–ì–æ–ª–æ—Å</span><span class="info-val" id="mGender">-</span></div>
                    <div class="info-row"><span class="info-label">–°—Ç–∏–ª—å</span><span class="info-val" id="mStyleW">-</span></div>
                    <div class="info-row"><span class="info-label">–¢–µ–≥–∏</span><span class="info-val" id="mTags">-</span></div>
                </div>
            </div>
            <div class="modal-main">
                <div class="info-label" style="font-size:0.9rem; margin-bottom:15px;">–ê—É–¥–∏–æ —Ñ–∞–π–ª—ã</div>
                <div id="mTracksContainer"></div>
                <div style="margin-top:40px;">
                    <div class="info-label" style="font-size:0.9rem; margin-bottom:10px;">–¢–µ–∫—Å—Ç / –ü—Ä–æ–º–ø—Ç</div>
                    <div id="mLyrics" style="white-space: pre-wrap; color: #bbb; line-height: 1.6; background:#161616; padding:20px; border-radius:10px; font-size:0.95rem;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="keysModal" onclick="if(event.target === this) closeKeysModal()">
    <div class="modal" style="max-width: 500px; height: auto;">
        <div class="modal-header"><div class="modal-title">API –ö–ª—é—á–∏</div><button class="close-btn" onclick="closeKeysModal()">√ó</button></div>
        <div class="modal-body" style="flex-direction: column; padding: 25px; overflow-y: auto;">
            <p style="font-size: 0.85rem; color: #888; margin-top: 0;">–í–∞—à–∏ –∫–ª—é—á–∏ (—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ). –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Å–≤–æ–∏.</p>
            <textarea id="keysInput" style="width: 100%; height: 200px; font-family: monospace; font-size: 0.85rem; white-space: pre; background:#111; color:#ccc; border:1px solid #333; padding:10px; border-radius:8px;" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á–∏ —Å—é–¥–∞..."></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <span id="keysStatus" style="font-size: 0.8rem; color: #666;">ID: <span id="dispUserId">...</span></span>
                <button class="create-btn" style="width: auto; padding: 10px 24px; margin:0;" onclick="saveKeys()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="global-player" id="globalPlayer">
    <button class="gp-close-btn" onclick="closeGlobalPlayer()">√ó</button>
    <div class="gp-info">
        <img src="" id="gpCover" class="gp-cover">
        <div class="gp-meta"><span id="gpTitle" class="gp-title">–ë–µ–∑ —Ç—Ä–µ–∫–∞</span><span id="gpStatus" class="gp-artist">...</span></div>
    </div>
    <div class="gp-controls">
        <div class="gp-btns"><button class="gp-btn" onclick="seek(-5)">‚è™</button><button class="gp-btn gp-play" id="gpPlayBtn" onclick="toggleGlobalPlay()">‚ñ∂</button><button class="gp-btn" onclick="seek(5)">‚è©</button></div>
        <div class="gp-progress-wrap"><span id="gpTimeCurrent">0:00</span><input type="range" class="gp-range" id="gpProgress" value="0" step="0.1" oninput="scrub(this.value)"><span id="gpTimeTotal">0:00</span></div>
    </div>
    <div class="gp-extras">
        <button class="fx-btn" id="btnMax" onclick="toggleMaximizer()">MAX</button>
        <button class="fx-btn" id="btnEq" onclick="toggleEqPanel()">EQ</button>
        <div id="rmsContainer"><canvas id="rmsCanvas" width="120" height="14"></canvas><div id="rmsValue">-‚àû dB</div></div>
        <div style="width: 80px; display:flex; align-items:center;">üîä <input type="range" style="width:60px; height:3px; margin-left:5px;" min="0" max="1" step="0.01" oninput="setVolume(this.value)"></div>
    </div>
    <div class="fx-popup" id="fxPanel">
        <div class="info-label">3-Band Equalizer</div>
        <div class="fx-row"><span>Low</span> <input type="range" class="fx-slider" id="eqLow" min="-20" max="20" value="0" oninput="setFilter('low', this.value)"></div>
        <div class="fx-row"><span>Mid</span> <input type="range" class="fx-slider" id="eqMid" min="-20" max="20" value="0" oninput="setFilter('mid', this.value)"></div>
        <div class="fx-row"><span>High</span> <input type="range" class="fx-slider" id="eqHigh" min="-20" max="20" value="0" oninput="setFilter('high', this.value)"></div>
        <div style="border-top:1px solid #333; margin: 10px 0;"></div>
        <div class="info-label">Maximizer (Boost)</div>
        <div class="fx-row"><span>Gain</span> <input type="range" class="fx-slider" id="maxGain" min="0" max="6" step="0.1" value="0" oninput="setMaximizerGain(this.value)"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
<script>
    // ========== USER ID & KEYS SYSTEM ==========
    const LOCAL_KEYS_KEY = 'suno_api_keys';
    const USER_ID_KEY = 'suno_user_id';

    function getUserId() {
        let uid = localStorage.getItem(USER_ID_KEY);
        if (!uid) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–ª—É—á–∞–π–Ω—ã–π ID, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            uid = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            localStorage.setItem(USER_ID_KEY, uid);
        }
        return uid;
    }

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º UserID –≤ –º–æ–¥–∞–ª–∫–µ
    const dispUserEl = document.getElementById('dispUserId');
    if(dispUserEl) dispUserEl.textContent = getUserId();

    function getLocalKeysRaw() { return (localStorage.getItem(LOCAL_KEYS_KEY) || '').trim(); }
    function getLocalKeysArray() {
        const raw = getLocalKeysRaw();
        if (!raw) return [];
        return raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }
    function saveLocalKeysFromTextarea(text) {
        const arr = (text || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        localStorage.setItem(LOCAL_KEYS_KEY, arr.join('\n'));
    }
    function ensureKeysOrOpenModal() {
        if (getLocalKeysArray().length === 0) {
            appLog("–ù–µ—Ç –∫–ª—é—á–µ–π API ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ üîë", 'info');
            openKeysModal();
            return false;
        }
        return true;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º X-User-Id –≤–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
    async function apiFetch(path, opts = {}) {
        const keysRaw = getLocalKeysRaw();
        if (!keysRaw) throw new Error('–ö–ª—é—á–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. –í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á.');

        const headers = {
            ...(opts.headers || {}),
            'X-User-Keys': keysRaw,
            'X-User-Id': getUserId()
        };

        if (opts.body instanceof FormData) return fetch(path, { ...opts, headers });
        return fetch(path, { ...opts, headers });
    }

    let currentModel = 'V5';
    let currentGender = 'any';
    let uploadedRefUrl = null;
    let historyData = [];

    // --- LOGGING ---
    function appLog(msg, type='info') {
        const p = document.getElementById('consolePanel');
        const d = document.createElement('div');
        d.className = 'log-entry';
        const time = new Date().toLocaleTimeString();
        d.innerHTML = `<span class="log-time">${time}</span> ${msg}`;
        if(type === 'error') d.style.color = '#ff5555';
        else if(type === 'success') d.style.color = '#55ff55';
        p.insertBefore(d, p.firstChild);
        console.log(`[${type}]`, msg);
    }

    // --- UI LOGIC ---
    function toggleMode() {
        const isCustom = document.getElementById('customModeToggle').checked;
        const disp = isCustom ? 'flex' : 'none';
        document.getElementById('styleGroup').style.display = disp;
        document.getElementById('titleGroup').style.display = disp;
        document.getElementById('lyricsLabel').textContent = isCustom ? "–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏" : "–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Å–Ω–∏";
    }
    function toggleInstrumental() {
        const isInst = document.getElementById('instrumentalToggle').checked;
        const prompt = document.getElementById('prompt');
        if(isInst) {
            prompt.disabled = true; prompt.style.opacity = 0.5;
            prompt.placeholder = "–†–µ–∂–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª–∞ (–¢–µ–∫—Å—Ç –æ—Ç–∫–ª—é—á–µ–Ω)";
        } else {
            prompt.disabled = false; prompt.style.opacity = 1;
            prompt.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ...";
        }
    }
    function toggleAdvanced() {
        const content = document.getElementById('advancedContent');
        content.classList.toggle('show');
        document.getElementById('advArrow').textContent = content.classList.contains('show') ? '‚ñ≤' : '‚ñº';
    }
    function setModel(m, el) {
        currentModel = m;
        document.querySelectorAll('#modelSelect .model-opt').forEach(d => d.classList.remove('active'));
        el.classList.add('active');
    }
    function setGender(g, el) {
        currentGender = g;
        el.parentNode.parentNode.querySelectorAll('.model-opt').forEach(b => {
            b.style.background = 'var(--input-bg)';
            b.style.color = 'var(--text-muted)';
            b.style.borderColor = '#333';
        });
        el.style.background = 'var(--text-main)';
        el.style.color = 'black';
        el.style.borderColor = 'white';
    }
    function openKeysModal() {
        document.getElementById('keysModal').classList.add('open');
        document.getElementById('keysInput').value = getLocalKeysRaw();
        const disp = document.getElementById('dispUserId');
        if(disp) disp.textContent = getUserId();
    }
    function closeKeysModal() { document.getElementById('keysModal').classList.remove('open'); }
    async function saveKeys() {
        saveLocalKeysFromTextarea(document.getElementById('keysInput').value);
        appLog(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.`, 'success');
        closeKeysModal();
        refreshHistory();
    }

    // --- DETAILS MODAL ---
    function openModal(taskId) {
        const item = historyData.find(t => t.task_id === taskId);
        if(!item) return;
        document.getElementById('mTitle').textContent = item.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        document.getElementById('mStatus').textContent = (item.status || '').toUpperCase();
        document.getElementById('mTaskId').textContent = item.task_id;
        document.getElementById('mLyrics').textContent = item.prompt || "–¢–µ–∫—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω.";
        const meta = item.metadata || {};
        document.getElementById('mModel').textContent = meta.model || "-";
        document.getElementById('mGender').textContent = meta.gender || "-";
        document.getElementById('mStyleW').textContent = meta.style || "-";
        document.getElementById('mTags').textContent = item.tags || "-";
        const tracksContainer = document.getElementById('mTracksContainer');
        tracksContainer.innerHTML = '';
        if (item.clips && item.clips.length > 0) {
            item.clips.forEach((clip, idx) => {
                const url = clip.url || clip.audio_url || clip.audioUrl || '';
                const title = clip.title || item.title || `–¢—Ä–µ–∫ ${idx+1}`;
                const div = document.createElement('div');
                div.style = "background:#222; padding:15px; border-radius:8px; margin-bottom:10px;";
                div.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:5px;">${title}</div>
                    <audio controls src="${url}" style="width:100%"></audio>
                    <div style="margin-top:8px;">
                        <a href="${url}" target="_blank" style="color:#888; text-decoration:none; font-size:0.8rem; margin-right:15px;">–°–∫–∞—á–∞—Ç—å MP3</a>
                        <button style="background:none; border:1px solid #555; color:#ccc; border-radius:4px; padding:4px 8px; cursor:pointer;" onclick="downloadWithFX('${url}', '${title.replace(/'/g, '')}', 320, this)">–°–∫–∞—á–∞—Ç—å —Å FX</button>
                    </div>`;
                tracksContainer.appendChild(div);
            });
            const mCover = document.getElementById('mCover');
            if(item.clips[0] && (item.clips[0].image_url || item.clips[0].imageUrl)) {
                mCover.src = item.clips[0].image_url || item.clips[0].imageUrl;
                document.getElementById('mCoverContainer').style.display = 'block';
            } else document.getElementById('mCoverContainer').style.display = 'none';
        } else { tracksContainer.innerHTML = '<div style="color:#666;">–ê—É–¥–∏–æ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ –∏–ª–∏ –æ—à–∏–±–∫–∞.</div>'; }
        document.getElementById('detailModal').classList.add('open');
    }
    function closeModal() { document.getElementById('detailModal').classList.remove('open'); }

    // --- UPLOAD ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        document.getElementById('fileName').textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        const fd = new FormData(); fd.append('file', file);
        try {
            if (!ensureKeysOrOpenModal()) return;
            const res = await apiFetch('/api/upload-file', { method:'POST', body: fd });
            const data = await res.json();
            if(data.public_url) {
                uploadedRefUrl = data.public_url;
                document.getElementById('fileName').textContent = "‚úÖ " + file.name;
                appLog("–ó–∞–≥—Ä—É–∂–µ–Ω–æ: " + file.name, 'success');
            } else throw new Error("–ù–µ—Ç URL");
        } catch(err) {
            document.getElementById('fileName').textContent = "‚ùå –û—à–∏–±–∫–∞";
            appLog("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message, 'error');
        }
    });

    // --- GENERATE ---
    async function generate() {
        const btn = document.getElementById('genBtn');
        const status = document.getElementById('statusMsg');
        const isCustom = document.getElementById('customModeToggle').checked;
        const prompt = document.getElementById('prompt').value;
        const style = document.getElementById('style').value;
        const title = document.getElementById('title').value;

        if(!document.getElementById('instrumentalToggle').checked && !prompt.trim()) { alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ"); return; }
        if (!ensureKeysOrOpenModal()) return;

        btn.disabled = true; status.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
        const payload = {
            mode: isCustom ? 'custom' : 'simple',
            task_type: uploadedRefUrl ? 'cover_music' : 'create_music',
            title: title, tags: style, prompt: prompt, ref_url: uploadedRefUrl,
            options: {
                model: currentModel, instrumental: document.getElementById('instrumentalToggle').checked,
                vocal_gender: currentGender, style_influence: document.getElementById('styleWeight').value,
                weirdness: document.getElementById('weirdness').value, negative_tags: document.getElementById('negativeTags').value,
                persona_id: document.getElementById('personaId').value, audio_weight: document.getElementById('audioWeight').value
            }
        };

        try {
            const res = await apiFetch('/api/generate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const data = await res.json();
            if(data.task_id) {
                status.textContent = "ID: " + data.task_id;
                appLog("–°—Ç–∞—Ä—Ç –∑–∞–¥–∞—á–∏: " + data.task_id, 'success');
                await refreshHistory();
                poll(data.task_id);
            } else {
                status.textContent = "–û—à–∏–±–∫–∞ API"; btn.disabled = false;
                appLog("–û—à–∏–±–∫–∞: " + JSON.stringify(data), 'error');
            }
        } catch(e) { status.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; btn.disabled = false; appLog("–°–±–æ–π: " + e.message, 'error'); }
    }

    function poll(id) {
        const interval = setInterval(async () => {
            try {
                const res = await apiFetch(`/api/check/${id}`, { method: 'GET' });
                const data = await res.json();
                let state = 'submitted';
                if(data.data && data.data.length > 0) state = data.data[0].state.toLowerCase();

                if(state === 'succeeded' || state === 'completed') {
                    clearInterval(interval); document.getElementById('genBtn').disabled = false; document.getElementById('statusMsg').textContent = "–ì–æ—Ç–æ–≤–æ!";
                    appLog(`–ó–∞–¥–∞—á–∞ ${id} –≤—ã–ø–æ–ª–Ω–µ–Ω–∞`, 'success'); refreshHistory();
                } else if (state === 'failed') {
                    clearInterval(interval); document.getElementById('genBtn').disabled = false; document.getElementById('statusMsg').textContent = "–°–±–æ–π";
                    appLog(`–ó–∞–¥–∞—á–∞ ${id} –ø—Ä–æ–≤–∞–ª–µ–Ω–∞`, 'error'); refreshHistory();
                }
            } catch(e) { /* silent */ }
        }, 4000);
    }

    async function refreshHistory() {
        try {
            if (!ensureKeysOrOpenModal()) { document.getElementById('feedList').innerHTML = '<div style="color:#666;text-align:center;">–ù—É–∂–Ω—ã –∫–ª—é—á–∏</div>'; return; }
            await apiFetch('/api/history/refresh', { method:'POST' });
            const res = await apiFetch('/api/history', { method: 'GET' });
            historyData = await res.json();
            renderFeed(historyData);
        } catch(e) { appLog("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: " + e.message, 'error'); }
    }

    function renderFeed(items) {
        const feed = document.getElementById('feedList'); feed.innerHTML = '';
        if(items.length === 0) { feed.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#444; margin-top:50px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>'; return; }

        items.forEach((item) => {
            const clips = (Array.isArray(item.clips) && item.clips.length > 0) ? item.clips : null;
            if (clips) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–ª–∏–ø—ã - —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—ã–π –æ—Ç–¥–µ–ª—å–Ω–æ
                clips.forEach((clip, index) => {
                    const img = clip.image_url || clip.imageUrl || item.clips[0].image_url || 'https://via.placeholder.com/400x400?text=No+Img';
                    const audioUrl = clip.audio_url || clip.audioUrl || clip.url;
                    const trackTitle = (clip.title || item.title || 'Untitled') + (clips.length > 1 ? ` [${index+1}]` : '');
                    createCard(feed, { taskId: item.task_id, title: trackTitle, tags: item.tags || 'Pop', img: img, audioUrl: audioUrl, status: item.status, isCover: item.type === 'cover_music' });
                });
            } else {
                // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–¥–∞—á–∏
                createCard(feed, { taskId: item.task_id, title: item.title || 'Generating...', tags: item.tags || '...', img: 'https://via.placeholder.com/400x400?text=Wait...', audioUrl: null, status: item.status, isCover: item.type === 'cover_music' });
            }
        });
    }

    function createCard(container, data) {
        const card = document.createElement('div'); card.className = 'card';
        let statusClass = 'submitted';
        if(data.status === 'completed' || data.status === 'succeeded') statusClass = 'succeeded';
        if(data.status === 'failed') statusClass = 'failed';
        let tagsHtml = '';
        if(data.tags) { data.tags.split(',').slice(0, 3).forEach(t => { tagsHtml += `<span class="tag-pill">${t.trim()}</span>`; }); }
        const refHtml = data.isCover ? `<div class="ref-badge">üé§ –ö–∞–≤–µ—Ä</div>` : '';
        const safeTitle = (data.title || '').replace(/'/g, "\\'");
        const safeTags = (data.tags || '').replace(/'/g, "\\'");
        const safeImg = data.img;

        card.innerHTML = `
            <div class="card-img"><img src="${data.img}" loading="lazy"><div class="status-badge ${statusClass}">${data.status === 'submitted' ? '–ñ–¥—ë–º...' : data.status}</div>${refHtml}${data.audioUrl ? `<div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3); opacity:0; transition:0.2s; cursor:pointer;" class="hover-overlay" onclick="event.stopPropagation(); loadAndPlay('${data.audioUrl}', '${safeTitle}', '${safeImg}', '${safeTags}')"><div style="font-size:3rem; filter:drop-shadow(0 4px 10px rgba(0,0,0,0.5));">‚ñ∂</div></div>` : ''}</div>
            <div class="card-body"><div class="card-title">${data.title}</div><div class="card-tags">${tagsHtml}</div><div class="card-meta-row"><div class="meta-icon">üéµ ${data.taskId.slice(0,4)}</div><div class="meta-icon" style="margin-left:auto; display:flex; gap:10px;"><button class="delete-btn" onclick="openModal('${data.taskId}')" title="–î–µ—Ç–∞–ª–∏">‚ÑπÔ∏è</button><button class="delete-btn" onclick="deleteTask(event, '${data.taskId}')" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">üóë</button></div></div></div>
        `;
        card.onclick = (e) => { if(e.target.tagName !== 'BUTTON' && !e.target.classList.contains('hover-overlay')) { openModal(data.taskId); } };
        container.appendChild(card);
    }

    async function deleteTask(e, id) {
        e.stopPropagation();
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?")) return;
        try { await apiFetch('/api/history/' + id, { method: 'DELETE' }); refreshHistory(); } catch (err) { appLog("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + err.message, 'error'); }
    }

    async function importTask() {
        const id = prompt("–í–≤–µ–¥–∏—Ç–µ Task ID:");
        if(id) {
            try { await apiFetch('/api/history/import', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({taskId:id})}); refreshHistory(); } catch(e) { appLog("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + e.message, 'error'); }
        }
    }

    // --- AUDIO & FX ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const audioEl = new Audio(); audioEl.crossOrigin = "anonymous";
    const sourceNode = audioCtx.createMediaElementSource(audioEl);
    const gainNode = audioCtx.createGain(); const maxGainNode = audioCtx.createGain();
    const compressorNode = audioCtx.createDynamicsCompressor();
    const lowShelf = audioCtx.createBiquadFilter(); lowShelf.type = "lowshelf"; lowShelf.frequency.value = 320;
    const midPeaking = audioCtx.createBiquadFilter(); midPeaking.type = "peaking"; midPeaking.frequency.value = 1000; midPeaking.Q.value = 0.5;
    const highShelf = audioCtx.createBiquadFilter(); highShelf.type = "highshelf"; highShelf.frequency.value = 3200;
    const rmsAnalyser = audioCtx.createAnalyser(); rmsAnalyser.fftSize = 2048;

    sourceNode.connect(lowShelf); lowShelf.connect(midPeaking); midPeaking.connect(highShelf); highShelf.connect(maxGainNode); maxGainNode.connect(compressorNode); compressorNode.connect(rmsAnalyser); rmsAnalyser.connect(gainNode); gainNode.connect(audioCtx.destination);
    compressorNode.threshold.value = -24; compressorNode.knee.value = 30; compressorNode.ratio.value = 12; compressorNode.attack.value = 0.003; compressorNode.release.value = 0.25;

    let isPlaying = false;
    function closeGlobalPlayer() { audioEl.pause(); isPlaying = false; document.getElementById('globalPlayer').classList.remove('active'); document.getElementById('consolePanel').classList.remove('with-player'); updatePlayBtn(); }
    function loadAndPlay(url, title, img, tags) { if (!url) return; if(audioCtx.state === 'suspended') audioCtx.resume(); document.getElementById('globalPlayer').classList.add('active'); document.getElementById('consolePanel').classList.add('with-player'); document.getElementById('gpTitle').textContent = title; document.getElementById('gpStatus').textContent = tags; document.getElementById('gpCover').src = img || "https://via.placeholder.com/50"; audioEl.src = url; audioEl.play().then(() => { isPlaying = true; updatePlayBtn(); appLog(`–ò–≥—Ä–∞–µ—Ç: ${title}`, 'success'); }).catch(e => { console.error(e); appLog("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (CORS?)", 'error'); }); }
    function toggleGlobalPlay() { if(audioEl.paused) { audioEl.play(); isPlaying = true; } else { audioEl.pause(); isPlaying = false; } updatePlayBtn(); }
    function updatePlayBtn() { document.getElementById('gpPlayBtn').textContent = isPlaying ? "‚è∏" : "‚ñ∂"; }
    function seek(sec) { audioEl.currentTime += sec; }
    function scrub(val) { audioEl.currentTime = val; }
    function setVolume(val) { gainNode.gain.value = val; }
    audioEl.addEventListener('timeupdate', () => { document.getElementById('gpProgress').max = audioEl.duration || 0; document.getElementById('gpProgress').value = audioEl.currentTime; document.getElementById('gpTimeCurrent').textContent = fmtTime(audioEl.currentTime); document.getElementById('gpTimeTotal').textContent = fmtTime(audioEl.duration || 0); });
    function fmtTime(s) { return new Date(s * 1000).toISOString().substr(14, 5); }

    let maxActive = false;
    function toggleMaximizer() { maxActive = !maxActive; const btn = document.getElementById('btnMax'); btn.classList.toggle('on', maxActive); setMaximizerGain(maxActive ? 3.0 : 0); document.getElementById('maxGain').value = maxActive ? 3.0 : 0; }
    function setMaximizerGain(val) { const v = parseFloat(val); maxGainNode.gain.value = 1 + (v * 0.5); document.getElementById('btnMax').classList.toggle('on', v > 0.5); }
    function toggleEqPanel() { document.getElementById('fxPanel').classList.toggle('show'); }
    function setFilter(type, val) { val = parseFloat(val); if(type === 'low') lowShelf.gain.value = val; if(type === 'mid') midPeaking.gain.value = val; if(type === 'high') highShelf.gain.value = val; document.getElementById('btnEq').classList.toggle('on', lowShelf.gain.value!=0 || midPeaking.gain.value!=0 || highShelf.gain.value!=0); }

    async function fetchAudioBuffer(url) { const res = await fetch(url); const ab = await res.arrayBuffer(); return await audioCtx.decodeAudioData(ab); }
    async function renderWithFX(sourceBuffer) {
        const offlineCtx = new OfflineAudioContext(sourceBuffer.numberOfChannels, sourceBuffer.length, sourceBuffer.sampleRate);
        const src = offlineCtx.createBufferSource(); src.buffer = sourceBuffer;
        const low = offlineCtx.createBiquadFilter(); low.type="lowshelf"; low.frequency.value=320; low.gain.value=lowShelf.gain.value;
        const mid = offlineCtx.createBiquadFilter(); mid.type="peaking"; mid.frequency.value=1000; mid.Q.value=0.5; mid.gain.value=midPeaking.gain.value;
        const high = offlineCtx.createBiquadFilter(); high.type="highshelf"; high.frequency.value=3200; high.gain.value=highShelf.gain.value;
        const maxG = offlineCtx.createGain(); maxG.gain.value = maxGainNode.gain.value;
        const comp = offlineCtx.createDynamicsCompressor();
        comp.threshold.value = compressorNode.threshold.value; comp.knee.value = compressorNode.knee.value; comp.ratio.value = compressorNode.ratio.value; comp.attack.value = compressorNode.attack.value; comp.release.value = compressorNode.release.value;
        src.connect(low); low.connect(mid); mid.connect(high); high.connect(maxG); maxG.connect(comp); comp.connect(offlineCtx.destination);
        src.start(0); return await offlineCtx.startRendering();
    }
    function floatTo16Bit(flt) { let s = Math.max(-1, Math.min(1, flt)); return s < 0 ? s * 0x8000 : s * 0x7FFF; }
    function bufferToMp3(buffer, kbps) {
        const mp3encoder = new lamejs.Mp3Encoder(buffer.numberOfChannels, buffer.sampleRate, kbps);
        const mp3Data = []; const left = buffer.getChannelData(0); const right = buffer.numberOfChannels > 1 ? buffer.getChannelData(1) : null; const blk = 1152;
        for(let i=0; i<left.length; i+=blk) { const l = new Int16Array(left.subarray(i,i+blk).map(floatTo16Bit)); const r = right ? new Int16Array(right.subarray(i,i+blk).map(floatTo16Bit)) : undefined; const buf = mp3encoder.encodeBuffer(l, r); if(buf.length) mp3Data.push(buf); }
        const end = mp3encoder.flush(); if(end.length) mp3Data.push(end); return new Blob(mp3Data, {type:'audio/mpeg'});
    }
    async function downloadWithFX(url, title, kbps, btn) {
        try { btn.disabled = true; btn.textContent = "–†–µ–Ω–¥–µ—Ä–∏–Ω–≥..."; const buf = await fetchAudioBuffer(url); const rendered = await renderWithFX(buf); const blob = bufferToMp3(rendered, kbps); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = title + "_FX.mp3"; a.click(); } catch(e) { alert("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ (CORS?): " + e.message); } finally { btn.disabled = false; btn.textContent = "–°–∫–∞—á–∞—Ç—å —Å FX"; }
    }

    const rmsCanvas = document.getElementById('rmsCanvas'); const rmsCtx = rmsCanvas.getContext('2d'); const rmsValueEl = document.getElementById('rmsValue');
    function drawRMS() { requestAnimationFrame(drawRMS); const buf = new Float32Array(rmsAnalyser.fftSize); rmsAnalyser.getFloatTimeDomainData(buf); let sum = 0; for(let i=0;i<buf.length;i++) sum+=buf[i]*buf[i]; const rms = Math.sqrt(sum/buf.length); const db = 20*Math.log10(rms||1e-8); rmsValueEl.textContent = (db<=-100?'-‚àû':db.toFixed(1)) + ' dB'; rmsCtx.clearRect(0,0,120,14); rmsCtx.fillStyle = '#111'; rmsCtx.fillRect(0,0,120,14); const norm = Math.max(0, Math.min(1, (db+60)/60)); const g = rmsCtx.createLinearGradient(0,0,120,0); g.addColorStop(0,'#4caf50'); g.addColorStop(0.6,'#ffeb3b'); g.addColorStop(1,'#f44336'); rmsCtx.fillStyle = g; rmsCtx.fillRect(0,0, norm*120, 14); }
    drawRMS();

    // START
    toggleMode(); refreshHistory();
</script>
</body>
</html>